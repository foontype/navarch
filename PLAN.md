# NAVARCH Rev2 実装計画書

## 概要
NAVARCH.mdの設計に基づいて、Bashベースの単一スクリプトとしてNAVARCH CLIシステムを実装する。

## 実装フェーズ

### フェーズ1: 基本構造とコア機能
**目標**: 基本的なCLIフレームワークとディレクティブ関数システムの実装

#### 1.1 プロジェクト構造の構築
- `src/navarch`スクリプトファイルの作成
- 基本的なCLIオプション解析機能の実装
- ヘルプメッセージとバージョン表示機能の実装

#### 1.2 atlas.navarch処理エンジンの実装
- `atlas.navarch`ファイルの検索機能
- ディレクティブ関数（env、vendor、current）の動的定義
- `atlas.navarch`のsource実行によるディレクティブ収集
- 各ディレクティブ関数内でのリスト構築機能
- 記述順序の保持機能

#### 1.3 基本サブコマンドの実装
- サブコマンド（pull、build、up、down、clean）の骨格実装
- 各サブコマンドのヘルプ機能

### フェーズ2: pullコマンドとvendor機能
**目標**: GitHub依存関係のダウンロードとキャッシュ機能の実装

#### 2.1 vendorディレクティブの処理
- GitHub URLの解析（リポジトリ名、ブランチ/タグ抽出）
- `.cache`ディレクトリ構造の作成
- gitコマンドによるリポジトリのクローン機能

#### 2.2 キャッシュ管理
- 既存キャッシュの検出と更新機能
- キャッシュの整合性チェック
- エラーハンドリング（ネットワークエラー、権限エラー等）

#### 2.3 pullコマンドの完成
- vendorディレクティブの一括処理
- 進捗表示機能
- 詳細ログ出力機能

### フェーズ3: 再帰処理とサブコマンド実行
**目標**: 依存関係の再帰処理とサブコマンド関数の実行機能

#### 3.1 再帰的atlas.navarch処理
- vendor/currentディレクトリ内の`atlas.navarch`検出
- 依存関係ツリーの構築
- 循環依存の検出とエラーハンドリング

#### 3.2 サブコマンド関数の実行エンジン
- 各`atlas.navarch`からの関数定義抽出（`declare -f`活用）
- 関数の一時保存と実行順序管理
- 実行時のエラーハンドリングと継続/停止制御

#### 3.3 build/up/down/cleanコマンドの実装
- 記述順序での実行（build/up）
- 逆順実行（down/clean）
- 各プロジェクトでの関数実行
- 実行結果のログ出力

### フェーズ4: 環境変数とcurrent機能
**目標**: 環境変数の管理とローカル依存関係の処理

#### 4.1 envディレクティブの処理
- `.env`ファイルの読み込み機能
- 環境変数の設定と継承
- 複数環境ファイルの優先順位処理

#### 4.2 currentディレクティブの処理
- ローカルパスの解決と検証
- 相対パス/絶対パスの正規化
- ディレクトリ存在チェック

### フェーズ5: テスト実装
**目標**: Batsによる自動テスト体制の構築

#### 5.1 テスト環境の構築
- `tests/`ディレクトリの作成
- Batsテストファイルの作成
- テスト用フィクスチャの準備

#### 5.2 ユニットテストの実装
- `test_navarch.bats`: 基本機能テスト
- `test_pull.bats`: pullコマンドテスト
- `test_build.bats`: buildコマンドテスト
- 各ディレクティブ機能のテスト

#### 5.3 統合テストの実装
- 実際のGitHubリポジトリを使用したpullテスト
- 複数依存関係での実行順序テスト
- エラーケースの網羅的テスト

### フェーズ6: インストール体制とドキュメント
**目標**: 配布とインストールの仕組みの完成

#### 6.1 インストールスクリプトの作成
- `install.sh`の実装
- curl経由でのワンライナーインストール
- 権限チェックとエラーハンドリング

#### 6.2 ドキュメントの整備
- README.mdの詳細化
- 使用例の充実
- トラブルシューティングガイド

## 技術的詳細

### ディレクトリ構造
```
navarch/
├── src/
│   └── navarch                    # メインスクリプト（実行可能）
├── tests/
│   ├── test_navarch.bats         # メイン機能テスト
│   ├── test_pull.bats            # pullコマンドテスト
│   ├── test_build.bats           # buildコマンドテスト
│   └── fixtures/                 # テストデータ
│       ├── sample_atlas.navarch
│       └── sample_project/
├── install.sh                    # インストールスクリプト
├── PLAN.md                       # 本ファイル
├── NAVARCH.md                    # 設計ドキュメント
└── README.md                     # ユーザードキュメント
```

### 主要なBash関数設計

#### ディレクティブ処理関数
- `define_directive_functions()`: env、vendor、current関数の動的定義
- `source_atlas_navarch()`: atlas.navarchのsource実行
- `build_dependency_tree()`: 収集されたディレクティブから依存関係ツリーを構築

#### 実行エンジン関数
- `execute_subcommand()`: サブコマンドの実行
- `load_functions()`: 関数の動的ロード
- `execute_in_order()`: 順序実行制御

#### ユーティリティ関数
- `log()`: ログ出力
- `error()`: エラー処理
- `validate_path()`: パス検証

### エラーハンドリング戦略
- 各段階での適切なエラーメッセージ
- 部分的失敗時の継続/停止選択肢
- デバッグモードでの詳細ログ出力
- 復旧可能なエラーでのリトライ機能

### パフォーマンス考慮事項
- キャッシュ機能による重複ダウンロードの回避
- 並列実行可能な処理の特定
- 大規模依存関係での処理時間最適化

## 開発スケジュール

### Week 1: フェーズ1+2
- 基本構造の実装
- pullコマンドの基本機能

### Week 2: フェーズ3
- 再帰処理の実装
- サブコマンド実行エンジン

### Week 3: フェーズ4+5
- 環境変数機能
- テスト実装

### Week 4: フェーズ6
- インストール体制
- ドキュメント整備

## 品質保証

### テストカバレッジ目標
- 全機能のユニットテスト: 90%以上
- 主要ユースケースの統合テスト: 100%
- エラーケースのテスト: 80%以上

### コードレビュー観点
- POSIX互換性の確保
- セキュリティ考慮（パス注入等）
- エラーハンドリングの適切性
- 可読性とメンテナンス性

## リリース計画

### v1.0.0 (MVP)
- 基本的なpull、build、up、down、clean機能
- シンプルなatlas.navarch処理
- 基本的なエラーハンドリング

### v1.1.0 (機能拡張)
- 高度な再帰処理
- 詳細ログ機能
- パフォーマンス最適化

### v1.2.0 (安定化)
- 包括的テストスイート
- ドキュメントの充実
- エラーハンドリングの強化