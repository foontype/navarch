# NAVARCH CLI実装関数リスト

## 実装ファイル
`src/navarch` - 単一のBashスクリプトファイル

## 実装する関数一覧

### 1. メイン・CLI制御関数

#### `main()`
- **概要**: CLIのメインエントリーポイント
- **引数**: `$@` (コマンドライン引数)
- **戻り値**: 終了コード
- **機能**: 引数解析後、適切なサブコマンド関数を呼び出し

#### `parse_args()`
- **概要**: コマンドライン引数の解析
- **引数**: `$@` (コマンドライン引数)
- **戻り値**: なし（グローバル変数設定）
- **機能**: サブコマンドとオプションフラグを解析・設定

#### `show_help()`
- **概要**: ヘルプメッセージの表示
- **引数**: `$1` (オプショナル: サブコマンド名)
- **戻り値**: なし
- **機能**: 全体または特定サブコマンドのヘルプを表示

#### `show_version()`
- **概要**: バージョン情報の表示
- **引数**: なし
- **戻り値**: なし
- **機能**: navarchのバージョン番号を表示

### 2. atlas.navarch処理エンジン

#### `find_atlas_navarch()`
- **概要**: atlas.navarchファイルの検索
- **引数**: `$1` (検索開始ディレクトリ、省略時はカレント)
- **戻り値**: 0=成功, 1=失敗
- **機能**: カレントまたは指定ディレクトリでatlas.navarchを検索
- **出力**: ATLAS_NAVARCH_PATH変数にパスを設定

#### `define_directive_functions()`
- **概要**: ディレクティブ関数の動的定義
- **引数**: なし
- **戻り値**: なし
- **機能**: env()、vendor()、current()関数をグローバル名前空間に定義

#### `source_atlas_navarch()`
- **概要**: atlas.navarchファイルのsource実行
- **引数**: `$1` (atlas.navarchファイルパス)
- **戻り値**: 0=成功, 1=失敗
- **機能**: ディレクティブ関数を有効化してatlas.navarchを実行

#### `build_dependency_tree()`
- **概要**: 依存関係ツリーの構築
- **引数**: なし
- **戻り値**: 0=成功, 1=失敗
- **機能**: 収集したディレクティブから実行順序付きリストを作成
- **出力**: PROJECT_LIST配列に実行順序でプロジェクト情報を格納

### 3. ディレクティブ関数（動的定義）

#### `env()`
- **概要**: 環境変数ファイル指定（動的定義される関数）
- **引数**: `$1` (環境ファイルパス)
- **戻り値**: なし
- **機能**: ENV_LIST配列に環境ファイルパスを追加

#### `vendor()`
- **概要**: GitHub依存関係指定（動的定義される関数）
- **引数**: `$1` (GitHubリポジトリURL)
- **戻り値**: なし
- **機能**: VENDOR_LIST配列にリポジトリ情報を追加

#### `current()`
- **概要**: ローカル依存関係指定（動的定義される関数）
- **引数**: `$1` (ローカルディレクトリパス)
- **戻り値**: なし
- **機能**: CURRENT_LIST配列にディレクトリパスを追加

### 4. 関数実行エンジン

#### `load_functions()`
- **概要**: atlas.navarchからサブコマンド関数を抽出
- **引数**: `$1` (atlas.navarchファイルパス)
- **戻り値**: 0=成功, 1=失敗
- **機能**: declare -fを使用して関数定義を保存

#### `execute_subcommand()`
- **概要**: 指定サブコマンドの実行制御
- **引数**: `$1` (サブコマンド名), `$2` (プロジェクトディレクトリ)
- **戻り値**: 0=成功, 1=失敗
- **機能**: 指定ディレクトリで該当サブコマンド関数を実行

#### `execute_in_order()`
- **概要**: プロジェクトリストの順序実行制御
- **引数**: `$1` (サブコマンド名), `$2` (順序フラグ: "normal"|"reverse")
- **戻り値**: 0=成功, 1=失敗
- **機能**: PROJECT_LISTを指定順序で処理

### 5. サブコマンド実装関数

#### `cmd_pull()`
- **概要**: pullサブコマンドの実装
- **引数**: なし
- **戻り値**: 0=成功, 1=失敗
- **機能**: VENDOR_LISTの全リポジトリをキャッシュにダウンロード

#### `cmd_build()`
- **概要**: buildサブコマンドの実装
- **引数**: なし
- **戻り値**: 0=成功, 1=失敗
- **機能**: PROJECT_LISTを記述順でbuild関数実行

#### `cmd_up()`
- **概要**: upサブコマンドの実装
- **引数**: なし
- **戻り値**: 0=成功, 1=失敗
- **機能**: PROJECT_LISTを記述順でup関数実行

#### `cmd_down()`
- **概要**: downサブコマンドの実装
- **引数**: なし
- **戻り値**: 0=成功, 1=失敗
- **機能**: PROJECT_LISTを逆順でdown関数実行

#### `cmd_clean()`
- **概要**: cleanサブコマンドの実装
- **引数**: なし
- **戻り値**: 0=成功, 1=失敗
- **機能**: downを実行後、PROJECT_LISTを逆順でclean関数実行

### 6. リポジトリ・キャッシュ管理

#### `clone_repository()`
- **概要**: GitHubリポジトリのクローン実行
- **引数**: `$1` (リポジトリURL), `$2` (キャッシュディレクトリパス)
- **戻り値**: 0=成功, 1=失敗
- **機能**: gitクローンまたは既存キャッシュの更新

#### `parse_github_url()`
- **概要**: GitHub URLの解析
- **引数**: `$1` (GitHub URL)
- **戻り値**: 0=成功, 1=失敗
- **機能**: URLから owner/repo、ブランチ/タグ情報を抽出
- **出力**: REPO_OWNER, REPO_NAME, REPO_REF変数に設定

#### `create_cache_dir()`
- **概要**: キャッシュディレクトリ構造の作成
- **引数**: `$1` (プロジェクトルートパス)
- **戻り値**: 0=成功, 1=失敗
- **機能**: .cache/github.com/以下のディレクトリ構造を作成

#### `update_cache()`
- **概要**: 既存キャッシュの更新処理
- **引数**: `$1` (キャッシュディレクトリパス)
- **戻り値**: 0=成功, 1=失敗
- **機能**: git pullで既存キャッシュを最新に更新

#### `check_cache_integrity()`
- **概要**: キャッシュの整合性チェック
- **引数**: `$1` (キャッシュディレクトリパス)
- **戻り値**: 0=整合性OK, 1=破損
- **機能**: .gitディレクトリの存在とgit statusの確認

### 7. 環境変数管理

#### `load_env_files()`
- **概要**: 環境ファイルの読み込み
- **引数**: なし
- **戻り値**: 0=成功, 1=失敗
- **機能**: ENV_LISTの全ファイルを順序通りに読み込み

#### `set_environment()`
- **概要**: 環境変数の設定
- **引数**: `$1` (キー=値の文字列)
- **戻り値**: 0=成功, 1=失敗
- **機能**: 指定された環境変数を現在のシェルに設定

### 8. 再帰処理

#### `detect_recursive_atlas()`
- **概要**: 依存ディレクトリ内のatlas.navarch検出
- **引数**: `$1` (検索対象ディレクトリパス)
- **戻り値**: 0=検出あり, 1=検出なし
- **機能**: 指定ディレクトリ内のatlas.navarchファイルを検出

#### `detect_circular_dependency()`
- **概要**: 循環依存の検出
- **引数**: `$1` (現在のパス), `$2` (訪問済みパスリスト)
- **戻り値**: 0=循環なし, 1=循環検出
- **機能**: 依存関係ツリーで循環依存をチェック

#### `process_recursively()`
- **概要**: 再帰的atlas.navarch処理
- **引数**: `$1` (処理対象ディレクトリパス)
- **戻り値**: 0=成功, 1=失敗
- **機能**: 依存ディレクトリを再帰的に処理してPROJECT_LISTに追加

### 9. パス・検証ユーティリティ

#### `validate_path()`
- **概要**: パスの検証
- **引数**: `$1` (検証対象パス)
- **戻り値**: 0=有効, 1=無効
- **機能**: ファイル/ディレクトリの存在と権限をチェック

#### `normalize_path()`
- **概要**: パスの正規化
- **引数**: `$1` (正規化対象パス)
- **戻り値**: なし
- **機能**: 相対パスを絶対パスに変換
- **出力**: NORMALIZED_PATH変数に正規化パスを設定

#### `resolve_relative_path()`
- **概要**: 相対パスの解決
- **引数**: `$1` (基準ディレクトリ), `$2` (相対パス)
- **戻り値**: なし
- **機能**: 基準ディレクトリからの相対パスを絶対パスに変換
- **出力**: RESOLVED_PATH変数に解決パスを設定

### 10. ログ・エラーハンドリング

#### `log()`
- **概要**: ログ出力
- **引数**: `$1` (ログレベル), `$2` (メッセージ)
- **戻り値**: なし
- **機能**: レベル付きログを標準出力に出力

#### `error()`
- **概要**: エラー処理とプログラム終了
- **引数**: `$1` (エラーメッセージ), `$2` (終了コード、省略時は1)
- **戻り値**: プログラム終了
- **機能**: エラーメッセージを標準エラー出力してプログラム終了

#### `warn()`
- **概要**: 警告メッセージ出力
- **引数**: `$1` (警告メッセージ)
- **戻り値**: なし
- **機能**: 警告メッセージを標準エラー出力（処理継続）

#### `debug()`
- **概要**: デバッグログ出力
- **引数**: `$1` (デバッグメッセージ)
- **戻り値**: なし
- **機能**: DEBUG_MODE=1時のみデバッグメッセージを出力

### 11. 進捗・結果表示

#### `show_progress()`
- **概要**: 進捗状況の表示
- **引数**: `$1` (現在の項目), `$2` (全体数)
- **戻り値**: なし
- **機能**: 進捗バーまたはパーセンテージを表示

#### `report_results()`
- **概要**: 実行結果のレポート
- **引数**: なし
- **戻り値**: なし
- **機能**: 成功/失敗の統計情報を表示

## グローバル変数

### 設定・状態変数
- `NAVARCH_VERSION`: navarchのバージョン番号
- `DEBUG_MODE`: デバッグモードフラグ (0/1)
- `VERBOSE_MODE`: 詳細出力モードフラグ (0/1)
- `PROJECT_ROOT`: プロジェクトのルートディレクトリパス

### ディレクティブ収集配列
- `ENV_LIST[]`: env()で収集された環境ファイルパスのリスト
- `VENDOR_LIST[]`: vendor()で収集されたリポジトリ情報のリスト
- `CURRENT_LIST[]`: current()で収集されたローカルパスのリスト

### 実行制御配列
- `PROJECT_LIST[]`: 実行順序でプロジェクト情報を格納した配列

### 作業用変数
- `ATLAS_NAVARCH_PATH`: 現在処理中のatlas.navarchファイルパス
- `REPO_OWNER`: 解析したGitHubリポジトリのオーナー名
- `REPO_NAME`: 解析したGitHubリポジトリ名
- `REPO_REF`: 解析したGitHubリポジトリのブランチ/タグ
- `NORMALIZED_PATH`: normalize_path()で正規化されたパス
- `RESOLVED_PATH`: resolve_relative_path()で解決されたパス

## 実装順序の推奨

1. **基盤関数**: ログ・エラーハンドリング、パス・検証ユーティリティ
2. **CLI制御**: メイン関数、引数解析、ヘルプ・バージョン表示
3. **atlas.navarch処理**: ファイル検索、ディレクティブ関数定義、source実行
4. **リポジトリ管理**: GitHub URL解析、キャッシュ管理、クローン機能
5. **pullコマンド**: 基本的なvendor処理の実装
6. **関数実行エンジン**: サブコマンド関数の抽出・実行
7. **他のサブコマンド**: build、up、down、clean
8. **再帰処理**: 依存関係の再帰処理、循環依存検出
9. **環境変数管理**: env処理の実装
10. **進捗・結果表示**: ユーザビリティ向上機能

合計: **約40の関数**と**約10のグローバル変数**を単一のBashスクリプトファイル`src/navarch`に実装